# GitHub Actions PR作成権限エラー解決ガイド

## 🚨 エラー概要
```
Error: GitHub Actions is not permitted to create or approve pull requests
```

このエラーは、2022年5月3日以降に導入されたGitHubのセキュリティ強化により、GitHub ActionsがPRを作成する権限が制限されているために発生します。

## 📋 解決方法一覧

### 1. リポジトリ設定でのActions権限変更

#### 手順
1. リポジトリの **Settings** タブに移動
2. 左サイドバーの **Actions** → **General** をクリック
3. **Workflow permissions** セクションを探す
4. **"Allow GitHub Actions to create and approve pull requests"** チェックボックスを有効化
5. **Save** をクリック

#### URL例
```
https://github.com/YOUR_OWNER/YOUR_REPO/settings/actions
```

#### 注意事項
- 組織のリポジトリの場合、組織レベルの設定が優先される
- グレーアウトしている場合は組織設定を確認する必要がある

### 2. 組織レベル設定（該当する場合）

#### 手順
1. 組織の **Settings** に移動
2. **Actions** → **General** をクリック
3. **Workflow permissions** で **"Allow GitHub Actions to create and approve pull requests"** を有効化

#### URL例
```
https://github.com/organizations/YOUR_ORG/settings/actions
```

### 3. ワークフローファイルでのPermissions設定

#### 基本設定
```yaml
name: Automated Issue Resolution
on:
  issues:
    types: [opened]

permissions:
  contents: write        # ファイル作成・編集権限
  pull-requests: write   # PR作成権限
  issues: write          # Issue更新権限
  checks: write          # チェック実行権限

jobs:
  resolve:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create PR
        run: gh pr create --title "Fix" --body "Automated fix"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

#### より詳細な権限設定
```yaml
permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  actions: read
  security-events: write
  statuses: write
  metadata: read
```

### 4. Personal Access Token (PAT) の使用

#### PAT作成手順
1. GitHub → Settings → Developer settings → Personal access tokens
2. "Generate new token (classic)" を選択
3. 必要なスコープを選択:
   - `repo` (フルリポジトリアクセス)
   - `workflow` (ワークフロー更新)
   - `write:discussion` (Discussion更新)

#### ワークフローでの使用例
```yaml
steps:
  - name: Create Pull Request with PAT
    uses: peter-evans/create-pull-request@v6
    with:
      token: ${{ secrets.PAT_TOKEN }}
      branch: automated-fix
      title: "Automated solution"
      body: "Generated by automation system"
```

### 5. GitHub App Token の使用

#### GitHub App作成手順
1. GitHub → Settings → Developer settings → GitHub Apps
2. "New GitHub App" を作成
3. Repository permissions で必要な権限を設定
4. Private keyを生成・ダウンロード

#### ワークフローでの使用例
```yaml
- name: Generate GitHub App Token
  uses: actions/create-github-app-token@v1
  id: app-token
  with:
    app-id: ${{ vars.APP_ID }}
    private-key: ${{ secrets.APP_PRIVATE_KEY }}

- name: Create PR with App Token
  uses: peter-evans/create-pull-request@v6
  with:
    token: ${{ steps.app-token.outputs.token }}
```

## 🔧 PR作成を回避する方法 - Issue Comment自動化

### アプローチ
PR作成権限が得られない環境では、Issue上でのコメントによる解決報告に切り替えることで、自動化システムを機能させることができます。

### 実装例

#### ワークフロー設定
```yaml
name: Issue Comment Automation
on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write    # コメント作成権限のみ
  contents: read   # リポジトリ読み取り権限

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Analyze and Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/issue-comment-automation.js
```

#### コメント生成の例
```javascript
const comment = `🔍 **自動解析完了**

## 📋 Issue分析結果
- **タイプ**: ${issueType}
- **複雑度**: ${complexity}
- **推定作業時間**: ${estimatedTime}

## 🎯 推奨解決アプローチ
${recommendedApproach}

## 📝 実装ステップ
1. ${step1}
2. ${step2}
3. ${step3}

## 📁 変更が必要なファイル
${filesToModify.map(file => `- \`${file}\``).join('\n')}

## 🧪 テスト戦略
${testingStrategy}

---
🤖 [Claude Code](https://claude.ai/code)による自動解析`;

await octokit.rest.issues.createComment({
  owner,
  repo,
  issue_number: issueNumber,
  body: comment
});
```

## 📊 各方法の比較

| 方法 | 設定難易度 | セキュリティ | 機能性 | 推奨度 |
|------|------------|------------|--------|--------|
| リポジトリ設定変更 | 低 | 中 | 高 | ⭐⭐⭐⭐⭐ |
| PAT使用 | 中 | 低 | 高 | ⭐⭐⭐⭐ |
| GitHub App | 高 | 高 | 高 | ⭐⭐⭐⭐ |
| Issue Comment自動化 | 低 | 高 | 中 | ⭐⭐⭐ |

## 🎯 推奨解決順序

1. **第一選択**: リポジトリ設定でPR作成権限を有効化
2. **第二選択**: 組織設定で権限を有効化（組織リポジトリの場合）
3. **第三選択**: Personal Access Token を使用
4. **代替案**: Issue Comment自動化に切り替え

## ⚠️ セキュリティ考慮事項

### GITHUB_TOKEN の制限
- フォークからのPRでは読み取り専用
- 一部のAPIエンドポイントでは書き込み権限が制限される
- ワークフロー間での連鎖実行が制限される

### PAT使用時の注意
- 個人アカウントのPATは避け、専用のマシンアカウントを使用する
- 最小限の権限のみを付与する
- 定期的にトークンをローテーションする

### GitHub App使用時の利点
- より細かい権限制御が可能
- アプリケーション固有の認証
- 監査ログが詳細

## 🔧 トラブルシューティング

### よくある問題と解決法

#### 1. 設定がグレーアウトしている
- **原因**: 上位レベル（組織/Enterprise）で制限されている
- **解決**: 上位設定を先に変更する

#### 2. トークン権限エラー
```
Error: Resource not accessible by integration
```
- **原因**: 必要な権限が不足
- **解決**: permissions セクションに適切な権限を追加

#### 3. PAT認証エラー
```
Error: Bad credentials
```
- **原因**: トークンが無効または期限切れ
- **解決**: 新しいPATを生成し、Secretsを更新

## 📈 段階的移行戦略

### フェーズ1: 即座の解決（Issue Comment）
- PR作成を停止
- Issue Comment自動化に切り替え
- 基本機能を維持

### フェーズ2: 権限設定の調整
- リポジトリ/組織設定を調整
- 権限問題を解決
- PR作成機能を復活

### フェーズ3: セキュリティ強化
- GitHub Appを導入
- より細かい権限制御
- 監査機能の強化

## 🎉 成功確認

以下の条件が満たされれば、PR作成が可能になります：

```bash
# テストコマンド
gh pr create --title "Test PR" --body "Permission test" --draft
```

成功時の出力例：
```
✓ Created pull request #123: Test PR
  https://github.com/owner/repo/pull/123
```

## 📚 参考資料

- [GitHub Actions permissions documentation](https://docs.github.com/en/actions/security-guides/automatic-token-authentication)
- [Managing GitHub Actions settings](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/enabling-features-for-your-repository/managing-github-actions-settings-for-a-repository)
- [Create Pull Request Action](https://github.com/marketplace/actions/create-pull-request)
- [GitHub Apps vs Personal Access Tokens](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps)

---

**注意**: この問題は環境によって解決方法が異なります。最も適切な方法を選択し、セキュリティを考慮して実装してください。